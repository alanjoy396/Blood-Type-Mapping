<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .names {
        fill: none;
        stroke: #fff;
        stroke-linejoin: round;
    }

    /* Tooltip CSS */
    .d3-tip {
        line-height: 1.5;
        font-weight: 400;
        font-family:"avenir next", Arial, sans-serif;
        padding: 6px;
        background: rgba(0, 0, 0, 0.6);
        color: #FFA500;
        border-radius: 1px;
        pointer-events: none;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
        box-sizing: border-box;
        display: inline;
        font-size: 8px;
        width: 100%;
        line-height: 1.5;
        color: rgba(0, 0, 0, 0.6);
        position: absolute;
        pointer-events: none;
    }

    /* Northward tooltips */
    .d3-tip.n:after {
        content: "\25BC";
        margin: -1px 0 0 0;
        top: 100%;
        left: 0;
        text-align: center;
    }

    /* Eastward tooltips */
    .d3-tip.e:after {
        content: "\25C0";
        margin: -4px 0 0 0;
        top: 50%;
        left: -8px;
    }

    /* Southward tooltips */
    .d3-tip.s:after {
        content: "\25B2";
        margin: 0 0 1px 0;
        top: -8px;
        left: 0;
        text-align: center;
    }

    /* Westward tooltips */
    .d3-tip.w:after {
        content: "\25B6";
        margin: -4px 0 0 -1px;
        top: 50%;
        left: 100%;
    }
    .details{
      color:white;
    }
</style>
<body>
<!-- gotta load d3 -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- use queues to make sure the data loads properly -->
<script src="https://d3js.org/queue.v1.js"></script>

<!-- get topojson so you can parse the map -->
<script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>

<!-- colors! important -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<!-- <script src="d3-tip.js"></script> -->

<!-- Buttons to switch blood type -->
<button onclick="changeBloodType(0)">A+</button>
<button onclick="changeBloodType(1)">A-</button>
<button onclick="changeBloodType(2)">B+</button>
<button onclick="changeBloodType(3)">B-</button>
<button onclick="changeBloodType(4)">AB+</button>
<button onclick="changeBloodType(5)">AB-</button>
<button onclick="changeBloodType(6)">O+</button>
<button onclick="changeBloodType(7)">O-</button>
<button onclick="changeBloodType(8)">A</button>
<button onclick="changeBloodType(9)">B</button>
<button onclick="changeBloodType(10)">AB</button>
<button onclick="changeBloodType(11)">O</button>
<button onclick="DisplayMax()">MAX</button>
<script>

var rh = false; // by default, rh values are preferred not to be shown

// var format = d3.format(",");

/*
var tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([-10, 0])
            .html(function(d){
                return tipStats(d);
            })
*/

var margin = {top: 0, right: 0, bottom: 0, left: 0},
    width = 960 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var color = d3.scaleSequential(d3.interpolateReds);

var path = d3.geoPath();

var svg = d3.select('body').append('svg')
            .attr('width', width)
            .attr('height', height)
            .append('g')
                .attr('class', 'map');

var projection = d3.geoMercator()
                    .scale(130)
                    .translate([width/2, height/1.5]);

var path = d3.geoPath().projection(projection);

//svg.call(tip);


var country_data;
var q = queue();
q.defer(d3.json, "https://raw.githubusercontent.com/alanjoy396/Blood-Type-Mapping/master/data/map/world_countries.json");
q.defer(d3.csv, "https://raw.githubusercontent.com/alanjoy396/Blood-Type-Mapping/master/data/popdata/PopData%20-%20Sheet1.csv");
q.await(load_data);


function load_data(error, data, blood_types){
    var blood_typesByID = [];

    for (var i = 0; i < data.objects.countries.geometries.length; i++){
        var thisCountry = data.objects.countries.geometries[i];
        var b_types = blood_types.filter(obj=>obj["id"]==thisCountry.id);
        if (b_types[0]){
            thisCountry.blood_types = {
                Apos: b_types[0]['A+'],
                Aneg: b_types[0]['A-'],
                Bpos: b_types[0]['B+'],
                Bneg: b_types[0]['B-'],
                ABpos: b_types[0]['AB+'],
                ABneg: b_types[0]['AB-'],
                Opos: b_types[0]['O+'],
                Oneg: b_types[0]['O-'],
                Aboth: b_types[0]['A+']*1.0+b_types[0]['A-']*1.0,
                Bboth: b_types[0]['B+']*1.0+b_types[0]['B-']*1.0,
                ABboth: b_types[0]['B+']*1.0+b_types[0]['AB-']*1.0,
                Oboth: b_types[0]['O+']*1.0+b_types[0]['O-']*1.0
            };
        }
    }


    // this part calculates the maxes for each blood type so that it can color things in a more
    // meaningful way later on.
    let bloodTypes = ["Apos", "Aneg",
                      "Bpos", "Bneg",
                      "ABpos", "ABneg",
                      "Opos", "Oneg",
                      "Aboth", "Bboth",
                      "ABboth", "Oboth"];

    var allCountries = data.objects.countries.geometries.filter(obj => {return obj.id});
    allCountries.max = {
      Apos:   -0.1,
      Aneg:   -0.1,
      Bpos:   -0.1,
      Bneg:   -0.1,
      ABpos:  -0.1,
      ABneg:  -0.1,
      Opos:   -0.1,
      Oneg:   -0.1,
      Aboth:  -0.1,
      Bboth:  -0.1,
      ABboth: -0.1,
      Oboth:  -0.1
    };
    for (index = 0; index < allCountries.length; index++) {
      if (allCountries[index]){
        if (allCountries[index].blood_types) {
          for (i = 0; i < bloodTypes.length; i++){
              if (allCountries[index].blood_types[bloodTypes[i]]*1.0 > allCountries.max[bloodTypes[i]]){
                allCountries.max[bloodTypes[i]] = allCountries[index].blood_types[bloodTypes[i]];
              }
          }
        }
      }
    }

    allCountries.max.Aboth = (allCountries.max.Apos * 1.0) + (allCountries.max.Aneg * 1.0);
    allCountries.max.Bboth = (allCountries.max.Bpos * 1.0) + (allCountries.max.Bneg * 1.0);
    allCountries.max.ABboth = (allCountries.max.ABpos * 1.0) + (allCountries.max.ABneg * 1.0);
    allCountries.max.Oboth = (allCountries.max.Opos * 1.0) + (allCountries.max.Oneg * 1.0);

    data.objects.countries.geometries.max = allCountries.max;
    country_data = data;
    ready(country_data);
}

function ready(country_data) {

    svg.append("g")
            .attr("class", "countries")
        .selectAll("path")
            .data(topojson.feature(country_data, country_data.objects.countries).features)
        .enter()
            .append("path")
            .attr("d", path)
            .style("fill", function(d) {
                let country = country_data.objects.countries.geometries.filter(obj => {return obj.id === d.id});
                let allCountries = country_data.objects.countries.geometries;
                if (country[0]){
                    if (country[0].blood_types) {
                        return color((country[0].blood_types["Apos"]*1.0) / (allCountries.max["Apos"]*1.0));
                    }
                    else {
                        return d3.color("gray");
                    }
                }
                else {
                    return d3.color("black");
                }
            })
            .style('stroke', 'white')
            .style('stroke-width', 1.5)
            .style("opacity",0.8)
                .style("stroke", "white")
                .style("stroke-width", 0.3)
                .on('mouseover', function(d) {
                    d3.select(this)
                        .style("opacity", 1)
                        .style("stroke", "white")
                        .style("stroke-width", 3);
                })
                .on('mouseout', function(d){
                    d3.select(this)
                        .style("opacity", 0.8)
                        .style("stroke", "white")
                        .style("stroke-width", 0.3);
                });

svg.append("path")
    .datum(topojson.mesh(topojson.feature(country_data, country_data.objects.countries).features, function(a, b) {return a.id != b.id; }))
    .attr("class", "names")
    .attr("d", path);
}

function changeBloodType(type){
  let blood_types = ["Apos", "Aneg",
                    "Bpos", "Bneg",
                    "ABpos", "ABneg",
                    "Opos", "Oneg",
                    "Aboth", "Bboth",
                    "ABboth", "Oboth"];

    d3.selectAll("path")
    .transition()
    .duration(100)
    .style("fill", function(d) {
        let country = country_data.objects.countries.geometries.filter(obj => {return obj.id === d.id});
        let allCountries = country_data.objects.countries.geometries;
        if (country[0]){
            if (country[0].blood_types) {
                return color(country[0].blood_types[blood_types[type]] / allCountries.max[blood_types[type]]);
            }
            else {
                return d3.color("gray");
            }
        }
        else {
            return d3.color("black");
        }
    })

}

function DisplayMax(){
  let blood_types = ["Apos", "Aneg",
                    "Bpos", "Bneg",
                    "ABpos", "ABneg",
                    "Opos", "Oneg"];
    var localmax= -1;
    var maxtype = -1;

    d3.selectAll("path")
    .transition()
    .duration(100)
    .style("fill", function(d) {
        let country = country_data.objects.countries.geometries.filter(obj => {return obj.id === d.id});
        let allCountries = country_data.objects.countries.geometries;
        if (country[0]){
            if (country[0].blood_types) {
              localmax= -1;
              maxtype = -1;
              //forloop record local max apply color based on category
              for (i = 0; i < blood_types.length; i++){
                if (country[0].blood_types[blood_types[i]]*1.0 > localmax){
                  console.log(country[0].blood_types[blood_types[i]]*1.0 + " > " + localmax);
                  localmax = country[0].blood_types[blood_types[i]]*1.0;
                  maxtype = i;
                }
              }
              console.log( maxtype);
              switch (maxtype) {
                case 0:
                  return d3.color("green");
                  break;
                case 1:
                  return d3.color("green");
                  break;
                case 2:
                  return d3.color("green");
                  break;
                case 3:
                  return d3.color("green");
                  break;
                case 4:
                  return d3.color("green");
                  break;
                case 5:
                  return d3.color("green");
                  break;
                case 6:
                  return d3.color("blue");
                case 7:
                  return d3.color("green");
                }
              }
            else {
                return d3.color("gray");
            }
        }
        else {
            return d3.color("black");
        }
    })

}

function tipStats(country){
    var str = "<strong>" + country.properties.name + ": </strong><br>";
    if (!rh){
        str += "<strong> A: </strong>" + country.blood_types.Apos*1.0 + country.blood_types.Aneg*1.0 + "<br>";
        str += "<strong> B: </strong>" + country.blood_types.Bpos*1.0 + country.blood_types.Bneg*1.0 + "<br>";
        str += "<strong> AB: </strong>" + country.blood_types.ABpos*1.0 + country.blood_types.ABneg*1.0 + "<br>";
        str += "<strong> O: </strong>" + country.blood_types.Opos*1.0 + country.blood_types.Oneg*1.0 + "<br>";
    }
    else {
        str += "<strong> A+: </strong>" + country.blood_types.Apos + "<br>";
        str += "<strong> A-: </strong>" + country.blood_types.Aneg + "<br>";
        str += "<strong> B+: </strong>" + country.blood_types.Bpos + "<br>";
        str += "<strong> B-: </strong>" + country.blood_types.Bneg + "<br>";
        str += "<strong> AB+: </strong>" + country.blood_types.ABpos + "<br>";
        str += "<strong> AB-: </strong>" + country.blood_types.ABneg + "<br>";
        str += "<strong> O+: </strong>" + country.blood_types.Opos + "<br>";
        str += "<strong> O-: </strong>" + country.blood_types.Oneg + "<br>";
    }

}

</script>
</body>
</html>
